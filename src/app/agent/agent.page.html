<ion-header [translucent]="true">
  <ion-toolbar class="app-text">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Build with Agent</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="bg-cream app-text">
  <div class="agent-inner px-4 py-4 max-w-2xl mx-auto flex flex-col gap-4">
    @if (!sessionId) {
      <!-- Start: describe what to build -->
      <div class="start-form flex flex-col gap-4">
        <p class="text-navy/90">Describe what you want to build. The agent will create files and run commands for you.</p>
        <ion-item lines="none" class="agent-item">
          <ion-textarea
            label="What do you want to build?"
            labelPlacement="stacked"
            [(ngModel)]="initialPrompt"
            placeholder="e.g. A Next.js todo app with dark mode and categories"
            rows="4"
          ></ion-textarea>
        </ion-item>

        <!-- Connect GitHub - required for Cursor agent -->
        <div class="git-connect-section">
          <ion-item lines="none" button (click)="showGitConnect = !showGitConnect" class="cursor-pointer">
            <ion-icon [name]="showGitConnect ? 'chevron-down' : 'chevron-forward'" slot="start"></ion-icon>
            <ion-label class="text-navy">Connect GitHub</ion-label>
          </ion-item>
          @if (showGitConnect) {
            <div class="pl-6 pr-4 pb-3 space-y-2">
              <p class="text-sm text-navy/70">Connect your GitHub account to use the Cursor agent. Create a token at GitHub → Settings → Developer settings → Personal access tokens. For classic tokens, enable the <strong>repo</strong> scope. For fine-grained tokens, grant "Contents" and "Metadata" write access.</p>
              <ion-item lines="none">
                <ion-input
                  label="Personal access token"
                  labelPlacement="stacked"
                  type="password"
                  [(ngModel)]="agentGitToken"
                  name="agentGitToken"
                  placeholder="ghp_..."
                ></ion-input>
              </ion-item>
              <ion-item lines="none">
                <ion-checkbox [(ngModel)]="agentGitCreateNew" name="agentGitCreateNew" labelPlacement="end">
                  Create new repository
                </ion-checkbox>
              </ion-item>
              @if (agentGitCreateNew) {
                <ion-item lines="none">
                  <ion-input
                    label="Repository name"
                    labelPlacement="stacked"
                    [(ngModel)]="agentRepoName"
                    name="agentRepoName"
                    placeholder="my-todo-app"
                  ></ion-input>
                </ion-item>
              }
            </div>
          }
        </div>

        @if (error) {
          <ion-note color="danger" class="block px-2">{{ error }}</ion-note>
        }
        <ion-button (click)="startSession()" [disabled]="starting" expand="block">
          {{ starting ? 'Starting…' : 'Start' }}
        </ion-button>
      </div>
    } @else {
      <!-- Build log panel (real-time agent activity) -->
      @if (logs.length > 0) {
        <div class="log-panel rounded-xl border border-navy/20 overflow-hidden">
          <div
            class="flex items-center justify-between px-3 py-2 bg-navy/5 border-b border-navy/10 cursor-pointer"
            (click)="showLogPanel = !showLogPanel"
          >
            <span class="text-sm font-medium text-navy/90">Agent activity</span>
            <ion-icon [name]="showLogPanel ? 'chevron-down' : 'chevron-forward'" class="text-navy/70"></ion-icon>
          </div>
          @if (showLogPanel) {
            <div class="p-2 text-xs font-mono overflow-y-auto max-h-48 bg-navy/5 text-navy/90 space-y-0.5">
              @for (log of logs; track $index) {
                <div class="log-line whitespace-pre-wrap break-words">{{ log }}</div>
              }
            </div>
          }
        </div>
      }

      <!-- Chat -->
      <div class="chat-panel flex flex-col flex-1 min-h-[300px] rounded-xl border border-navy/20 overflow-hidden">
        <div class="chat-messages flex-1 overflow-y-auto p-3 space-y-3">
          @for (msg of messages; track $index) {
            <div
              class="message flex"
              [class.justify-end]="msg.role === 'user'"
              [class.justify-start]="msg.role === 'assistant'"
            >
              <div
                class="message-bubble max-w-[85%] px-3 py-2 rounded-lg"
                [class.bg-navy/20]="msg.role === 'user'"
                [class.ml-auto]="msg.role === 'user'"
                [class.bg-navy/10]="msg.role === 'assistant'"
              >
                <div class="whitespace-pre-wrap text-sm">{{ msg.content }}</div>
                @if (msg.toolSummary && msg.toolSummary.length > 0) {
                  <div class="tool-summary mt-2 text-xs text-navy/70">
                    Ran: {{ msg.toolSummary.slice(-3).join('; ') }}
                  </div>
                }
              </div>
            </div>
          }
          @if (loading) {
            <div class="message flex justify-start">
              <div class="message-bubble bg-navy/10 px-3 py-2 rounded-lg text-sm text-navy/80">
                Agent is running…
              </div>
            </div>
          }
        </div>

        @if (error) {
          <ion-note color="danger" class="block px-3 py-2">{{ error }}</ion-note>
        }

        <!-- Connect GitHub (when in session - for Cursor agent) -->
        <div class="git-connect-section px-3 py-1 border-t border-navy/10">
          <ion-item lines="none" button (click)="showGitConnect = !showGitConnect" class="cursor-pointer min-h-[36px]">
            <ion-icon [name]="showGitConnect ? 'chevron-down' : 'chevron-forward'" slot="start" class="text-navy/70"></ion-icon>
            <ion-label class="text-sm text-navy">Connect GitHub (for Cursor agent)</ion-label>
          </ion-item>
          @if (showGitConnect) {
            <div class="pl-4 pr-2 pb-2 space-y-2">
              <ion-item lines="none" class="min-h-0">
                <ion-input
                  label="Personal access token"
                  labelPlacement="stacked"
                  type="password"
                  [(ngModel)]="agentGitToken"
                  placeholder="ghp_..."
                  class="text-sm"
                ></ion-input>
              </ion-item>
              <ion-item lines="none" class="min-h-0">
                <ion-checkbox [(ngModel)]="agentGitCreateNew" labelPlacement="end">Create new repository</ion-checkbox>
              </ion-item>
              @if (agentGitCreateNew) {
                <ion-item lines="none" class="min-h-0">
                  <ion-input
                    label="Repository name"
                    labelPlacement="stacked"
                    [(ngModel)]="agentRepoName"
                    placeholder="my-todo-app"
                    class="text-sm"
                  ></ion-input>
                </ion-item>
              }
            </div>
          }
        </div>

        <div class="chat-input p-3 border-t border-navy/10 flex gap-2">
          <ion-textarea
            [(ngModel)]="chatInput"
            placeholder="Ask for changes or additions…"
            rows="2"
            class="flex-1"
            [disabled]="loading"
          ></ion-textarea>
          <ion-button (click)="sendMessage()" [disabled]="loading || !chatInput.trim()">
            Send
          </ion-button>
        </div>
      </div>

      <div class="actions flex gap-2">
        <ion-button (click)="openDeployForm()">Deploy</ion-button>
        <ion-button fill="outline" (click)="goHome()">Back to home</ion-button>
      </div>
    }
  </div>

  <!-- Deploy modal / form -->
  @if (showDeployForm) {
    <div class="deploy-overlay fixed inset-0 bg-black/50 z-10 flex items-center justify-center p-4">
      <div class="deploy-form bg-cream rounded-xl p-4 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-semibold mb-3">Deploy to GitHub & Vercel</h3>
        <form (ngSubmit)="deploy()" class="flex flex-col gap-3">
          <ion-item lines="none">
            <ion-input
              label="App name"
              labelPlacement="stacked"
              [(ngModel)]="deployAppName"
              name="deployAppName"
              placeholder="my-awesome-app"
            ></ion-input>
          </ion-item>
          <ion-item lines="full" class="section-label">
            <ion-label><strong>Git (GitHub)</strong></ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-input
              label="Personal access token"
              labelPlacement="stacked"
              type="password"
              [(ngModel)]="gitToken"
              name="gitToken"
              placeholder="ghp_..."
            ></ion-input>
          </ion-item>
          <ion-item lines="none">
            <ion-checkbox [(ngModel)]="gitCreateNew" name="gitCreateNew" labelPlacement="end">
              Create new repository
            </ion-checkbox>
          </ion-item>
          @if (!gitCreateNew) {
            <ion-item lines="none">
              <ion-input
                label="Repository URL"
                labelPlacement="stacked"
                [(ngModel)]="gitRepoUrl"
                name="gitRepoUrl"
                placeholder="https://github.com/username/repo"
              ></ion-input>
            </ion-item>
          }
          <ion-item lines="full" class="section-label">
            <ion-label><strong>Vercel</strong></ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-input
              label="Vercel API token"
              labelPlacement="stacked"
              type="password"
              [(ngModel)]="vercelToken"
              name="vercelToken"
              placeholder="..."
            ></ion-input>
          </ion-item>
          <ion-item lines="none">
            <ion-input
              label="Team ID (optional)"
              labelPlacement="stacked"
              [(ngModel)]="vercelTeamId"
              name="vercelTeamId"
            ></ion-input>
          </ion-item>

          @if (deployResult) {
            <div class="deploy-result p-3 rounded" [class.deploy-ok]="deploySuccess" [class.deploy-fail]="!deploySuccess">
              @if (deploySuccess) {
                <p class="text-sm">Deployed successfully.</p>
                @if (deployResult.repo_url) {
                  <a [href]="deployResult.repo_url" target="_blank" rel="noopener" class="deploy-link">Open repo</a>
                }
                @if (deployResult.deploy_url) {
                  <a [href]="deployResult.deploy_url" target="_blank" rel="noopener" class="deploy-link">Open app</a>
                }
              } @else {
                <p class="text-sm">{{ deployResult.error || 'Deploy failed' }}</p>
                @if (deployResult.repo_url) {
                  <a [href]="deployResult.repo_url" target="_blank" rel="noopener" class="deploy-link">Open repo</a>
                }
              }
            </div>
          }

          <div class="flex gap-2 mt-2">
            <ion-button type="submit" [disabled]="deploying">
              {{ deploying ? 'Deploying…' : 'Deploy' }}
            </ion-button>
            <ion-button fill="outline" type="button" (click)="closeDeployForm()">
              Close
            </ion-button>
          </div>
        </form>
      </div>
    </div>
  }
</ion-content>
